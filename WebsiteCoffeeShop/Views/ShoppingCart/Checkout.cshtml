@model Order
@using WebsiteCoffeeShop.Models

@{
    var cartItems = ViewData["CartItems"] as List<CartItem>;
    var availableDiscountCodes = ViewData["AvailableDiscountCodes"] as List<DiscountCode>;
    var userRewardPoints = ViewData["UserRewardPoints"] as int? ?? 0;
}

<div class="container mt-5">
    <div class="checkout-card">
        <h2 class="text-center checkout-title">🛒 Thanh toán đơn hàng</h2>

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger" role="alert">
                @TempData["ErrorMessage"]
            </div>
        }

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success" role="alert">
                @TempData["SuccessMessage"]
            </div>
        }

        <div class="checkout-content">
            <!-- Phần trái: Danh sách sản phẩm -->
            <div class="checkout-left">
                <div class="checkout-section product-section">
                    <h4 class="section-title"><i class="bi bi-cart-check"></i> Sản phẩm của bạn</h4>
                    <div class="product-list">
                        @if (cartItems != null && cartItems.Any())
                        {
                            @foreach (var item in cartItems)
                            {
                                <div class="product-card">
                                    @{
                                        var imagePath = item.ImageUrl.StartsWith("/Images/") ? item.ImageUrl : Url.Content("~/Images/" + item.ImageUrl);
                                    }
                                    <div class="product-img-container">
                                        <img src="@imagePath" class="product-img" alt="@item.Name">
                                    </div>
                                    <div class="product-details">
                                        <h5 class="product-name">@item.Name</h5>
                                        <div class="product-info">
                                            <div class="product-price">@item.Price.ToString("C", new System.Globalization.CultureInfo("vi-VN"))</div>
                                            <div class="product-quantity">× @item.Quantity</div>
                                        </div>
                                        <div class="product-total">@((item.Price * item.Quantity).ToString("C", new System.Globalization.CultureInfo("vi-VN")))</div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-cart">
                                <i class="bi bi-cart-x-fill empty-cart-icon"></i>
                                <p>Giỏ hàng trống!</p>
                                <a href="/Products" class="btn btn-primary btn-sm">Tiếp tục mua sắm</a>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Phần phải: Form thanh toán -->
            <div class="checkout-right">
                <form asp-action="Checkout" asp-controller="ShoppingCart" method="post">
                    <div class="checkout-section">
                        <h4 class="section-title"><i class="bi bi-geo-alt-fill"></i> Thông tin giao hàng</h4>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                            <input type="text" name="ShippingAddress" class="form-control" placeholder="Nhập địa chỉ giao hàng" required>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="bi bi-chat-left-text"></i></span>
                            <textarea name="Notes" class="form-control" placeholder="Ghi chú thêm (nếu có)" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="checkout-section">
                        <h4 class="section-title"><i class="bi bi-gift"></i> Giảm giá & Ưu đãi</h4>

                        <!-- Mã giảm giá -->
                        <div class="discount-section mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                <input type="text" id="discountCodeInput" name="DiscountCode" class="form-control" placeholder="Nhập mã giảm giá">
                                <button type="button" id="applyDiscountBtn" class="btn btn-accent">Áp dụng</button>
                            </div>
                            <div id="discountMessage" class="mt-2"></div>

                            @if (availableDiscountCodes != null && availableDiscountCodes.Any())
                            {
                                <div class="available-codes mt-2">
                                    <small class="text-muted">Mã giảm giá có sẵn:</small>
                                    <div class="code-badges">
                                        @foreach (var code in availableDiscountCodes)
                                        {
                                            <span class="badge bg-info text-dark discount-badge"
                                                  data-code="@code.Code"
                                                  data-is-percentage="@code.IsPercentage.ToString().ToLower()"
                                                  data-discount-percent="@code.DiscountPercent"
                                                  data-discount-amount="@code.DiscountAmount"
                                                  data-min-order="@code.MinimumOrderAmount">
                                                @code.Code
                                                (@(code.IsPercentage ? $"{code.DiscountPercent}%" : $"{code.DiscountAmount.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))}"))
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Điểm thưởng -->
                        <div class="rewards-section mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="bi bi-star-fill text-warning"></i> Điểm thưởng của bạn: <strong>@userRewardPoints</strong></span>
                                <span class="text-muted small">(10 điểm = 10.000₫)</span>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-star"></i></span>
                                <input type="number" id="rewardPointsInput" name="RewardPointsUsed" class="form-control"
                                       placeholder="Nhập số điểm muốn sử dụng" min="0" max="@userRewardPoints" value="0">
                                <button type="button" id="applyPointsBtn" class="btn btn-accent">Áp dụng</button>
                            </div>
                            <div id="pointsMessage" class="mt-2"></div>
                        </div>
                    </div>

                    <div class="checkout-section">
                        <h4 class="section-title"><i class="bi bi-credit-card"></i> Phương thức thanh toán</h4>
                        <div class="payment-methods">
                            <div class="form-check payment-method">
                                <input class="form-check-input" type="radio" name="PaymentMethod" id="codPayment" value="COD" checked>
                                <label class="form-check-label" for="codPayment">
                                    <span class="payment-icon"><i class="bi bi-cash"></i></span>
                                    <span class="payment-title">Thanh toán khi nhận hàng (COD)</span>
                                </label>
                            </div>
                            <div class="form-check payment-method">
                                <input class="form-check-input" type="radio" name="PaymentMethod" id="bankTransfer" value="BankTransfer">
                                <label class="form-check-label" for="bankTransfer">
                                    <span class="payment-icon"><i class="bi bi-bank"></i></span>
                                    <span class="payment-title">Chuyển khoản ngân hàng</span>
                                </label>
                            </div>
                            <div class="form-check payment-method">
                                <input class="form-check-input" type="radio" name="PaymentMethod" id="momoPayment" value="Momo">
                                <label class="form-check-label" for="momoPayment">
                                    <span class="payment-icon momo-icon">M</span>
                                    <span class="payment-title">Ví MoMo</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-section order-summary">
                        <h4 class="section-title"><i class="bi bi-receipt"></i> Tổng quan đơn hàng</h4>
                        <div class="summary-row">
                            <div class="summary-label">Tạm tính:</div>
                            <div class="summary-value" id="subtotal">
                                @{
                                    var subtotal = cartItems?.Sum(i => i.Price * i.Quantity) ?? 0;
                                    @subtotal.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))
                                }
                            </div>
                        </div>
                        <div class="summary-row">
                            <div class="summary-label">Phí vận chuyển:</div>
                            <div class="summary-value" id="shippingFee">
                                @{
                                    var shippingFee = subtotal > 200000 ? 0 : 30000;
                                    @shippingFee.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))
                                }
                            </div>
                        </div>
                        <div class="summary-row">
                            <div class="summary-label">Giảm giá:</div>
                            <div class="summary-value text-danger" id="discountAmount">0₫</div>
                        </div>
                        <div class="summary-row">
                            <div class="summary-label">Điểm thưởng:</div>
                            <div class="summary-value text-danger" id="pointsDiscount">0₫</div>
                        </div>
                        <div class="summary-row total-row">
                            <div class="summary-label">Tổng thanh toán:</div>
                            <div class="summary-value total-amount" id="totalAmount">
                                @{
                                    var total = subtotal + shippingFee;
                                    @total.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))
                                }
                            </div>
                        </div>

                        <!-- Hidden fields for form submission -->
                        <input type="hidden" id="subtotalHidden" name="Subtotal" value="@subtotal">
                        <input type="hidden" id="shippingFeeHidden" name="ShippingFee" value="@shippingFee">
                        <input type="hidden" id="discountAmountHidden" name="DiscountAmount" value="0">
                        <input type="hidden" id="pointsDiscountHidden" name="PointsDiscountAmount" value="0">
                        <input type="hidden" id="totalAmountHidden" name="TotalAmount" value="@total">
                    </div>

                    <div class="checkout-actions">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-bag-check"></i> Đặt hàng
                        </button>
                        <a href="/ShoppingCart" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                            <i class="bi bi-arrow-left"></i> Quay lại giỏ hàng
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- jQuery library - Add this before your script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    $(document).ready(function() {
        // Constants
        const POINT_VALUE = 1000; // 1 điểm = 1.000₫
        let subtotal = @(cartItems?.Sum(i => i.Price * i.Quantity) ?? 0);
        let shippingFee = subtotal > 200000 ? 0 : 30000;
        let discountAmount = 0;
        let pointsDiscount = 0;

        // Format currency function
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 }).format(amount);
        }

        // Update total summary
        function updateTotalSummary() {
            let total = subtotal + shippingFee - discountAmount - pointsDiscount;
            if (total < 0) total = 0;

            $('#discountAmount').text('-' + formatCurrency(discountAmount));
            $('#pointsDiscount').text('-' + formatCurrency(pointsDiscount));
            $('#totalAmount').text(formatCurrency(total));

            // Update hidden fields
            $('#discountAmountHidden').val(discountAmount);
            $('#pointsDiscountHidden').val(pointsDiscount);
            $('#totalAmountHidden').val(total);
        }

        // Click on discount badge
        $('.discount-badge').click(function() {
            $('#discountCodeInput').val($(this).data('code'));
            $('#applyDiscountBtn').click();
        });

        // Apply discount code
        $('#applyDiscountBtn').click(function() {
            const code = $('#discountCodeInput').val().trim();
            if (!code) {
                $('#discountMessage').html('<div class="alert alert-warning">Vui lòng nhập mã giảm giá!</div>');
                return;
            }

            // Find the discount badge with matching code
            const discountBadge = $(`.discount-badge[data-code="${code}"]`);

            if (discountBadge.length) {
                const isPercentage = discountBadge.data('is-percentage') === 'true';
                const discountPercent = parseFloat(discountBadge.data('discount-percent'));
                const discountValue = parseFloat(discountBadge.data('discount-amount'));
                const minOrder = parseFloat(discountBadge.data('min-order'));

                if (subtotal < minOrder) {
                    $('#discountMessage').html(`<div class="alert alert-warning">Đơn hàng tối thiểu ${formatCurrency(minOrder)} để sử dụng mã này!</div>`);
                    return;
                }

                // Calculate discount
                discountAmount = isPercentage ? (subtotal * discountPercent / 100) : discountValue;

                $('#discountMessage').html(`<div class="alert alert-success">Đã áp dụng mã giảm giá: ${code}</div>`);
                updateTotalSummary();
            } else {
                $('#discountMessage').html('<div class="alert alert-danger">Mã giảm giá không hợp lệ!</div>');
            }
        });

        // Apply reward points
        $('#applyPointsBtn').click(function() {
            const pointsToUse = parseInt($('#rewardPointsInput').val()) || 0;
            const maxPoints = @userRewardPoints;

            if (pointsToUse < 0) {
                $('#pointsMessage').html('<div class="alert alert-warning">Số điểm không hợp lệ!</div>');
                return;
            }

            if (pointsToUse > maxPoints) {
                $('#pointsMessage').html('<div class="alert alert-warning">Bạn không đủ điểm thưởng!</div>');
                return;
            }

            pointsDiscount = pointsToUse * POINT_VALUE;
            $('#pointsMessage').html(`<div class="alert alert-success">Đã áp dụng ${pointsToUse} điểm (${formatCurrency(pointsDiscount)})</div>`);
            updateTotalSummary();
        });

        // Payment method details toggle
        $('.payment-method').click(function() {
            $(this).find('input').prop('checked', true);
        });
    });
</script>

<!-- CSS cho trang thanh toán -->
<style>
    .checkout-card {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 50px;
    }

    .checkout-title {
        color: #3a3a3a;
        font-weight: 700;
        margin-bottom: 30px;
    }

    .checkout-content {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }

    .checkout-left {
        flex: 1;
        min-width: 300px;
    }

    .checkout-right {
        flex: 1;
        min-width: 300px;
    }

    .checkout-section {
        background-color: #f9f9f9;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .product-section {
        max-height: 500px;
        overflow-y: auto;
    }

    .product-card {
        display: flex;
        align-items: center;
        background-color: #fff;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .product-img-container {
        width: 70px;
        height: 70px;
        overflow: hidden;
        border-radius: 5px;
        margin-right: 15px;
    }

    .product-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-details {
        flex: 1;
    }

    .product-name {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .product-info {
        display: flex;
        justify-content: space-between;
        color: #666;
        font-size: 14px;
    }

    .product-total {
        font-weight: 600;
        color: #333;
        margin-top: 5px;
    }

    .empty-cart {
        text-align: center;
        padding: 30px 0;
    }

    .empty-cart-icon {
        font-size: 40px;
        color: #ccc;
        margin-bottom: 10px;
    }

    .discount-badge {
        cursor: pointer;
        margin-right: 5px;
        margin-bottom: 5px;
        transition: all 0.2s;
    }

        .discount-badge:hover {
            transform: scale(1.05);
        }

    .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .payment-method {
        background-color: #fff;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.2s;
    }

        .payment-method:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

    .payment-icon {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 30px;
        height: 30px;
        background-color: #f0f0f0;
        border-radius: 50%;
        margin-right: 10px;
    }

    .momo-icon {
        background-color: #d82d8b;
        color: white;
        font-weight: bold;
        font-style: normal;
    }

    .order-summary {
        background-color: #f5f5f5;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .total-row {
        border-bottom: none;
        margin-top: 10px;
        font-weight: 700;
        font-size: 18px;
    }

    .btn-accent {
        background-color: #775dd0;
        color: white;
    }

        .btn-accent:hover {
            background-color: #6449c0;
            color: white;
        }

    /* Media query for mobile responsiveness */
    {
        flex-direction: column;
    }

    .checkout-card {
        padding: 15px;
    }

    }
</style>